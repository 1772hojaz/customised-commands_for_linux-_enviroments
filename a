#!/bin/bash

# Colors for output
red='\033[31m'
green='\033[0;32m'
reset_color='\033[0m'

# Staging all changes
git add .

# Prepare the diff for the commit (limited to 500 tokens/words)
diff=$(git diff --cached | head -n 50 | tr -d '\000')  # Limit to first 50 lines

# Handle case where there are no changes
if [[ -z "$diff" ]]; then
    echo -e "${red}No code changes to generate commit message.${reset_color}"
    exit 1
fi

# Pass the diff to the Python script via stdin and read generated message
commit_message_generated=$(python3 -c "
import sys
from transformers import pipeline, AutoTokenizer

# Read the diff from stdin
diff_text = sys.stdin.read()

# Truncate to model's max capacity (512 tokens)
tokenizer = AutoTokenizer.from_pretrained('narySt/codeT5p_CommitMessageGen')
truncated_text = tokenizer.decode(
    tokenizer.encode(diff_text, truncation=True, max_length=512)[1:-1]
    
try:
    # Use CPU explicitly and disable GPU
    generator = pipeline(
        'text2text-generation', 
        model='narySt/codeT5p_CommitMessageGen',
        device=-1  # Force CPU
    )
    
    # Generate with adjusted parameters
    message = generator(
        truncated_text,
        max_length=128,
        num_beams=5,
        early_stopping=True
    )[0]['generated_text']
    
    print(message.strip())
except Exception as e:
    print('Error:', str(e), file=sys.stderr)
    exit(1)
" <<< "$diff")

# Check result
if [ $? -ne 0 ] || [[ -z "$commit_message_generated" ]]; then
    echo -e "${red}Failed to generate commit message. Retrying with file list...${reset_color}"
    
    # Fallback to file list method
    added=$(git diff --cached --name-only --diff-filter=A | paste -sd ', ')
    modified=$(git diff --cached --name-only --diff-filter=M | paste -sd ', ')
    deleted=$(git diff --cached --name-only --diff-filter=D | paste -sd ', ')
    
    commit_message_generated="Update:"
    [[ -n "$added" ]] && commit_message_generated+=" Added ${added}"
    [[ -n "$modified" ]] && commit_message_generated+=" Modified ${modified}"
    [[ -n "$deleted" ]] && commit_message_generated+=" Deleted ${deleted}"
fi

# Commit and push
echo -e "${green}Commit message: $commit_message_generated${reset_color}"
if git commit -m "$commit_message_generated"; then
    git push && echo -e "${green}Successfully pushed!${reset_color}"
else
    echo -e "${red}Commit failed${reset_color}"
    exit 1
fi

